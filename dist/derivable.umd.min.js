!function(t,e){"use strict";t&&"function"==typeof t.define&&t.define.amd?t.define(["exports"],e):e("undefined"!=typeof exports?exports:t.Derivable={})}(this,function(t){"use strict";function e(t){for(var e=1;e<arguments.length;e++)for(var n=arguments[e],r=Z(n||{}),i=r.length;i--;){var u=r[i];t[u]=n[u]}return t}function n(t,e){return t===e?0!==t||1/t===1/e:t!==t&&e!==e}function r(t,e){return n(t,e)||t&&"function"==typeof t.equals&&t.equals(e)}function i(t,e){var n=t.indexOf(e);n<0&&t.push(e)}function u(t,e){var n=t.indexOf(e);n>=0&&t.splice(n,1)}function o(){return $++}function s(t,e){return Array.prototype.slice.call(t,e)}function a(t){return null!==t&&void 0!==t}function c(t){et=!!t}function f(t,e){return t._equals=e,t}function h(t){return t&&(t._type===rt||t._type===nt||t._type===it)}function l(t){return t&&(t._type===nt||t._type===it)}function _(t){return t&&(t._type===rt||t._type===it)}function p(t){return t&&t._type===it}function v(t,e){ft.push({parents:e,offset:0,child:t}),ht=t}function d(){return ft[ft.length-1]}function y(){ft.pop(),ht=0===ft.length?null:ft[ft.length-1].child}function g(t){if(null!==ht){var e=ft[ft.length-1];if(e.parents[e.offset]===t)e.offset++;else{var n=e.parents.indexOf(t);if(n===-1)void 0!==ht&&i(t._activeChildren,ht),e.offset===e.parents.length?e.parents.push(t):(e.parents.push(e.parents[e.offset]),e.parents[e.offset]=t),e.offset++;else if(n>e.offset){var r=e.parents[n];e.parents[n]=e.parents[e.offset],e.parents[e.offset]=r,e.offset++}}}}function m(t,e){for(var n=0,r=t._activeChildren.length;n<r;n++){var i=t._activeChildren[n];switch(i._type){case rt:case it:i._state!==ot&&(i._state=ot,m(i,e));break;case ut:e.push(i)}}}function w(t){for(var e=0,n=t.length;e<n;e++){var r=t[e];if(r._reacting)throw new Error("Synchronous cyclical reactions disallowed. Use setImmediate.");r._maybeReact()}}function b(){throw lt}function E(t){this.parent=t,this.id2originalValue={},this.modifiedAtoms=[]}function k(t){null!==_t&&(t._id in _t.id2originalValue||(_t.modifiedAtoms.push(t),_t.id2originalValue[t._id]=t._value));
}function A(){return null!==_t}function q(t){R();try{t.call(null,b)}catch(t){if(T(),t!==lt)throw t;return}x()}function O(t){A()?t():q(t)}function D(t){return function(){var e,n=s(arguments,0),r=this;return q(function(){e=t.apply(r,n)}),e}}function C(t){return function(){var e,n=s(arguments,0),r=this;return O(function(){e=t.apply(r,n)}),e}}function R(){_t=new E(_t)}function x(){var t=_t;if(_t=t.parent,null===_t){var e=[];t.modifiedAtoms.forEach(function(n){n.__equals(n._value,t.id2originalValue[n._id])?n._state=at:(n._state=st,m(n,e))}),w(e),t.modifiedAtoms.forEach(function(t){t._state=at})}}function T(){var t=_t;_t=t.parent,t.modifiedAtoms.forEach(function(e){e._value=t.id2originalValue[e._id],e._state=at,m(e,[])})}function j(){0===pt&&R(),pt++;var t=!1;return{tick:function(){if(t)throw new Error("trying to use ticker after release");x(),R()},reset:function(){if(t)throw new Error("trying to use ticker after release");T(),R()},release:function(){if(t)throw new Error("ticker already released");pt--,t=!0,0===pt&&x()}}}function V(t){this._deriver=t,this._parents=null,this._type=rt,this._value=tt,this._equals=null,this._activeChildren=[],this._state=ct,et&&(this.stack=Error().stack)}function S(t,e){if(u(t._activeChildren,e),0===t._activeChildren.length&&null!=t._parents){for(var n=t._parents.length,r=0;r<n;r++)S(t._parents[r],t);t._parents=null,t._state=ct}}function M(t){return new V(t)}function I(t,e,n){this._parent=t,this.react=e,this._governor=n||null,this._active=!1,this._reacting=!1,this._type=ut,et&&(this.stack=Error().stack)}function L(t,n,r){function i(t,e){if(!h(t)){if("function"==typeof t)return M(t);if("boolean"==typeof t)return M(function(){return t});throw Error("react "+e+" condition must be derivable, got: "+JSON.stringify(t))}return t}if("function"!=typeof n)throw Error("the first argument to .react must be a function");r=e({once:!1,from:!0,until:!1,when:!0,skipFirst:!1},r);var u=r.skipFirst,o=new I(t,function(t){u?u=!1:(n(t),r.once&&(this.stop(),f.stop()))}),s=i(r.until,"until"),a=i(r.when,"when"),c=M(function(){
return{until:s.get(),when:a.get()}}),f=new I(c,function(t){t.until?(o.stop(),this.stop()):t.when?o._active||o.start().force():o._active&&o.stop()});o._governor=f;var l=i(r.from,"from"),_=new I(l,function(t){t&&(f.start().force(),this.stop())});_.start().force()}function N(t){return this._id=o(),this._activeChildren=[],this._value=t,this._state=at,this._type=nt,this._equals=null,this}function P(t){return new N(t)}function z(t){V.call(this,t.get),this._lensDescriptor=t,this._type=it}function F(t){return new z(t)}function J(t){var e=s(arguments,1);return kt(function(){for(var n="",r=0;r<t.length;r++)n+=t[r],r<e.length&&(n+=U(e[r]));return n})}function U(t){return mt(t)?t.get():t}function B(t){return function(){var e=arguments,n=this;return kt(function(){return t.apply(n,Array.prototype.map.call(e,U))})}}function G(t){if(mt(t))return t.get();if(t instanceof Array)return t.map(G);if(t.constructor===Object){for(var e={},n=Z(t),r=n.length;r--;){var i=n[r];e[i]=G(t[i])}return e}return t}function H(t){if(t.constructor===Object||t instanceof Array)return kt(function(){return G(t)});throw new Error("`struct` expects plain Object or Array")}function K(t,e){var n=e;return function(e){var r=t.call(this,e,n);return n=e,r}}function Q(t){var e=[];v(void 0,e);try{t()}finally{y()}return e}function W(t){return function(){var e=arguments;return kt(function(){for(var n,r=0;r<e.length&&(n=U(e[r]),!t(n));r++);return n})}}function X(t){return t}function Y(t){return function(e){return!t(e)}}Object.defineProperty(t,"__esModule",{value:!0});var Z=Object.keys,$=0,tt=Object.freeze({equals:function(){return!1}}),et=!1,nt="ATOM",rt="DERIVATION",it="LENS",ut="REACTOR",ot=0,st=1,at=2,ct=3,ft=[],ht=null,lt={},_t=null,pt=0;e(V.prototype,{_clone:function(){return f(M(this._deriver),this._equals)},_forceEval:function(){var t,e=this,n=null;try{if(null===this._parents&&(this._parents=[]),v(this,this._parents),et)try{n=e._deriver()}catch(t){throw console.error(e.stack),t}else n=e._deriver();t=d().offset}finally{y()}this._state=this.__equals(n,this._value)?at:st;
for(var r=t,i=this._parents.length;r<i;r++){var u=this._parents[r];S(u,this),this._parents[r]=null}this._parents.length=t,this._value=n},_update:function(){if(null===this._parents)this._forceEval();else if(this._state===ot){for(var t=this._parents.length,e=0;e<t;e++){var n=this._parents[e];if(n._state===ot&&n._update(),n._state===st){this._forceEval();break}}this._state===ot&&(this._state=at)}},get:function(){if(g(this),this._activeChildren.length>0)this._update();else{v(void 0,[]);try{this._value=this._deriver()}finally{y()}}return this._value}}),e(I.prototype,{start:function(){return this._active=!0,i(this._parent._activeChildren,this),this._parent.get(),this},_force:function(t){try{this._reacting=!0,this.react(t)}catch(t){throw et&&console.error(this.stack),t}finally{this._reacting=!1}},force:function(){return this._force(this._parent.get()),this},_maybeReact:function(){if(!this._reacting&&this._active&&(null!==this._governor&&this._governor._maybeReact(),this._active)){var t=this._parent.get();this._parent._state===st&&this._force(t)}},stop:function(){return S(this._parent,this),this._active=!1,this}}),e(N.prototype,{_clone:function(){return f(P(this._value),this._equals)},set:function(t){k(this);var e=this._value;if(this._value=t,!A()&&!this.__equals(t,e))try{this._state=st;var n=[];m(this,n),w(n)}finally{this._state=at}},get:function(){return g(this),this._value}}),e(z.prototype,V.prototype,{_clone:function(){return f(new z(this._lensDescriptor),this._equals)},set:function(t){var e=this;return O(function(){e._lensDescriptor.set(t)}),this}});var vt=q,dt=c,yt=D,gt=j,mt=h,wt=l,bt=p,Et=_,kt=M,At=P,qt=C,Ot=O,Dt=F,Ct=W(X),Rt=W(a),xt=W(Y(X)),Tt=W(Y(a)),jt=Object.freeze({transact:vt,setDebugMode:dt,transaction:yt,ticker:gt,isDerivable:mt,isAtom:wt,isLensed:bt,isDerivation:Et,derivation:kt,atom:At,atomic:qt,atomically:Ot,lens:Dt,derive:J,unpack:U,lift:B,struct:H,wrapPreviousState:K,captureDereferences:Q,or:Ct,mOr:Rt,and:xt,mAnd:Tt}),Vt={derive:function(t,e,n,r,i){var u=this;switch(arguments.length){case 0:throw new Error(".derive takes at least one argument");
case 1:switch(typeof t){case"function":return kt(function(){return t(u.get())});case"string":case"number":return kt(function(){return u.get()[U(t)]});default:if(t instanceof Array)return t.map(function(t){return u.derive(t)});if(t instanceof RegExp)return kt(function(){return u.get().match(t)});if(h(t))return kt(function(){var e=t.get(),n=u.get();switch(typeof e){case"function":return e(n);case"string":case"number":return n[e];default:if(e instanceof RegExp)return n.match(e);throw Error("type error")}});throw Error("type error")}case 2:return kt(function(){return t(u.get(),U(e))});case 3:return kt(function(){return t(u.get(),U(e),U(n))});case 4:return kt(function(){return t(u.get(),U(e),U(n),U(r))});case 5:return kt(function(){return t(u.get(),U(e),U(n),U(r),U(i))});default:var o=[u].concat(s(arguments,1));return kt(function(){return t.apply(null,o.map(U))})}},react:function(t,e){L(this,t,e)},mReact:function(t,n){var r=this.mThen(!0,!1);if(n&&"when"in n&&n.when!==!0){var i=n.when;if("function"==typeof i||i===!1)i=kt(i);else if(!h(i))throw new Error("when condition must be bool, function, or derivable");r=i.and(r)}return this.react(t,e({},n,{when:r}))},is:function(t){var e=this;return this.derive(function(n){return e.__equals(n,U(t))})},and:function(t){return this.derive(function(e){return e&&U(t)})},or:function(t){return this.derive(function(e){return e||U(t)})},then:function(t,e){return this.derive(function(n){return U(n?t:e)})},mThen:function(t,e){return this.derive(function(n){return U(a(n)?t:e)})},mOr:function(t){return this.mThen(this,t)},mDerive:function(t){if(1===arguments.length&&t instanceof Array){var e=this;return t.map(function(t){return e.mDerive(t)})}return this.mThen(this.derive.apply(this,arguments))},mAnd:function(t){return this.mThen(t,this)},not:function(){return this.derive(function(t){return!t})},withEquality:function(t){if(t){if("function"!=typeof t)throw new Error("equals must be function")}else t=null;return f(this._clone(),t)},__equals:function(t,e){return(this._equals||r)(t,e)}};Vt.switch=function(){
var t=arguments,e=this;return this.derive(function(n){var r;for(r=0;r<t.length-1;r+=2)if(e.__equals(n,U(t[r])))return U(t[r+1]);if(r===t.length-1)return U(t[r])})};var St={swap:function(t){var e=s(arguments,0);return e[0]=this.get(),this.set(t.apply(null,e))},lens:function(t){var e=this;return new z({get:function(){return t.get(e.get())},set:function(n){e.set(t.set(e.get(),n))}})}};e(V.prototype,Vt),e(z.prototype,Vt,St),e(N.prototype,Vt,St);var Mt=vt,It=dt,Lt=yt,Nt=gt,Pt=mt,zt=wt,Ft=bt,Jt=Et,Ut=kt,Bt=At,Gt=qt,Ht=Ot,Kt=Dt,Qt=J,Wt=U,Xt=B,Yt=H,Zt=K,$t=Q,te=Ct,ee=Rt,ne=xt,re=Tt;t.Reactor=I,t.transact=Mt,t.setDebugMode=It,t.transaction=Lt,t.ticker=Nt,t.isDerivable=Pt,t.isAtom=zt,t.isLensed=Ft,t.isDerivation=Jt,t.derivation=Ut,t.atom=Bt,t.atomic=Gt,t.atomically=Ht,t.lens=Kt,t.derive=Qt,t.unpack=Wt,t.lift=Xt,t.struct=Yt,t.wrapPreviousState=Zt,t.captureDereferences=$t,t.or=te,t.mOr=ee,t.and=ne,t.mAnd=re,t.default=jt});
//# sourceMappingURL=dist/derivable.umd.min.js.map
//# sourceMappingURL=derivable.umd.min.js.map